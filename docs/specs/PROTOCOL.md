# Communication Protocol

This document outlines the security, signaling, and synchronization protocols.

## 1. Security & Encryption

All clipboard data is secured using **End-to-End Encryption (E2EE)**.

### Keys
- **Master Secret**: A high-entropy string generated by the creator (or a user-provided password).
- **Encryption Key**: Derived from the Master Secret (Argon2id).
- **Room ID**: A public identifier for the signaling channel.

### Cipher
- **Algorithm**: AES-256-GCM (Galois/Counter Mode).
- **Properties**: Authenticated Encryption (ensures confidentiality AND integrity).
- **Nonce/IV**: Unique random value for every message.

### Payload Structure (Encrypted)
```json
{
  "iv": "base64_string",
  "ciphertext": "base64_string",
  "senderId": "uuid_string"
}
```

## 2. Signaling Protocol (WebSocket)

Clients connect to the Relay Server to discover peers.

### Handshake
1. **Connect**: Client connects to `wss://relay/ws?roomId=ABC`.
2. **Announce**: Client sends `HELLO { myId: UUID }`.
3. **Peer List**: Server replies with list of existing peers in Room `ABC`.

### P2P Setup (WebRTC)
1. **Offer**: Client A generates WebRTC Offer -> Sends to Server (Target: Client B) -> Server forwards to Client B.
2. **Answer**: Client B generates Answer -> Sends to Server (Target: Client A) -> Server forwards to Client A.
3. **ICE**: Candidates are exchanged similarly via Server.

## 3. Data Synchronization Protocol

### Message Format (Decrypted)
Once a client decrypts a payload, the JSON structure is:
```typescript
interface ClipboardMessage {
  id: string;          // Unique ID for this clip
  timestamp: number;   // UTC Timestamp
  type: 'text' | 'image' | 'file_paths'; 
  content: string;     // The actual data (or base64)
  metadata?: any;
}
```

### Sync Logic
1. **Local Change**: 
   - User copies "Hello" on Device A.
   - Device A encrypts "Hello".
   - Device A sends encrypted blob to all connected P2P Peers.
   - If a peer is not reachable via P2P, Device A sends the blob to the Relay Server (broadcast).
   
2. **Remote Receive**:
   - Device B receives blob.
   - **Decrypts** using the Shared Secret.
     - *Failure*: If decryption fails (wrong key), ignore message.
   - **Timestamps**: Device B checks if `msg.timestamp` > `last_local_copy_timestamp`.
   - **Write**: Device B writes content to System Clipboard.
   - **Debounce**: Device B suppresses its own "Clipboard Change" listener for 1-2 seconds to prevent echoing the same message back to Device A.

## 4. Network Constraints
- **Payload Size**: Large files are not synced directly. Only file *paths* or small images/text.
- **Relay Limits**: The Relay may enforce a strict size limit (e.g., 256KB) for relayed messages to save bandwidth, whereas P2P WebRTC can support larger streams.